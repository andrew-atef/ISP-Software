# ISP Software - AI Coding Agent Guide

- **Stack & Purpose**: Laravel 12 + Filament 4 + Livewire app for ISP field ops (dispatch, payroll, inventory, invoicing).
- **Run/Build**: `composer setup` (install, env, migrate, npm build). `composer dev` runs serve, queue:listen --tries=1, pail, and npm dev. Tests use Pest (`composer test` or `php artisan test`). Vite config in [vite.config.js](vite.config.js) with Tailwind plugin.
- **Auth & Roles**: Roles backed by enums; Filament Shield manages permissions. Gate bypass for super_admin in [app/Providers/AppServiceProvider.php](app/Providers/AppServiceProvider.php). Filament resources live under [app/Filament](app/Filament) with InfoSection-based form schemas and table definitions.
- **Task Model Basics**: Core entity with parent/child links; enums cast on `task_type`, `status`, `financial_status`, etc. `Task::calculateTechPay()` returns stored `tech_price` snapshot (no recompute). See [app/Models/Task.php](app/Models/Task.php).
- **Pricing Rules**: JobPrice is the single source of truth; stored prices are historical—never recalculated. `financial_status` controls billing inclusion (DropBury children are NotBillable with `company_price=0`).
- **Automations (TaskObserver)**: Registered in AppServiceProvider. `saving`: fill `company_price`/`tech_price` only when null and not dirty, using JobPrice defaults. `updated`: when a NewInstall flips to Completed with `drop_bury_status=false` and no existing child, auto-creates a DropBury sub-task (NotBillable, tech_price from JobPrice). Also deducts recorded inventory consumptions once per task when status becomes Completed/Approved by creating `InventoryTransaction` entries and decrementing the assigned tech’s `InventoryWallet`. Logic in [app/Observers/TaskObserver.php](app/Observers/TaskObserver.php).
- **Inventory Model**: Items typed via `InventoryItemType` enum. Per-tech balances stored in `InventoryWallet`; movements logged in `InventoryTransaction`. Task-level consumptions (`TaskInventoryConsumption`) drive deductions via the observer.
- **Payroll & Loans**: Week-based (Sunday–Saturday) calculations via `Payroll::getWeekDateRange()`. Loans auto-create installments on `created()`; deductions occur per pay period. DropBury children incur tech cost only.
- **Invoices**: [app/Models/CompanyInvoice.php](app/Models/CompanyInvoice.php) auto-numbers invoices as `INV-YYYYMMWW[-##]` on `creating`. Billable tasks feed invoicing; NotBillable are excluded.
- **Integrations**: Wire3 identifiers on Customer (`wire3_cid`), User (`wire3_email`), Task (`saf_link`). PDFs via `barryvdh/laravel-dompdf`. Excel imports/exports via `maatwebsite/excel`. Calendar events rendered through `guava/calendar` (see `toCalendarEvent()` in Task). Live tech GPS shown via [app/Livewire/LiveTechLocationWidget.php](app/Livewire/LiveTechLocationWidget.php).
- **Seeding Strategy**: [database/seeders/DatabaseSeeder.php](database/seeders/DatabaseSeeder.php) seeds admin/dispatch/tech users, customers, inventory, JobPrice, loans, and tasks dated Jan 2026: Approved tasks in week 2, Completed in week 3 (with TaskDetail data including random `drop_bury_status`), Pending future-dated with no assigned tech. DropBury seeds are NotBillable; ServiceCalls include random issue/resolution text.
- **Conventions**: Use backed enums for casts; decimals via `'decimal:2'`; dates via `'date'`/`'datetime'`. Favor query scopes (e.g., `Task::billable()`). Respect manual form input over auto-fill. Maintain parent/child task integrity; avoid duplicating DropBury children and inventory deductions (observer is idempotent).
- **Key References**: Task rules and observer ([app/Models/Task.php](app/Models/Task.php), [app/Observers/TaskObserver.php](app/Observers/TaskObserver.php)); Filament resources ([app/Filament/Resources](app/Filament/Resources)); enums ([app/Enums](app/Enums)); dev scripts ([composer.json](composer.json)).
